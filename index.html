<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEBU Lern-App Verkehrsrecht/Verkehrslehre</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Definition der Verlagsfarbe #823125 als 'cd-primary'
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'cd-primary': '#823125', // Die gewünschte Hauptfarbe
                        'cd-hover': '#6e1d11',  // Eine etwas dunklere Variante für den Hover-Effekt
                    }
                }
            }
        }
    </script>
    <style>
        /* Konfigurieren der Inter-Schriftart */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
        }
        .container-card {
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            max-width: 900px;
        }
        .option-button, .category-card {
            transition: all 0.3s ease;
            transform: translateY(0);
        }
        .option-button:hover:not(.correct):not(.incorrect) {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .category-card:hover {
            transform: scale(1.02);
            box-shadow: 0 10px 20px rgba(100, 100, 100, 0.2);
            border-color: #823125; /* CD Farbe als Hover-Rand */
        }
        /* Korrekte und Falsche Antworten Visualisierung */
        .correct {
            background-color: #4ade80 !important;
            color: white !important;
            border-color: #15803d !important;
        }
        .incorrect {
            background-color: #f87171 !important;
            color: white !important;
            border-color: #b91c1c !important;
        }
        /* Styling für ausgewählte MC-Optionen */
        .selected-mc {
            background-color: #823125 !important;
            color: white !important;
            border-color: #6e1d11 !important;
        }
        /* Styling für Freitexteingabe */
        input.correct {
            background-color: #d1fae5 !important; /* light green */
            border-color: #34d399 !important;
        }
        input.incorrect {
            background-color: #fee2e2 !important; /* light red */
            border-color: #f87171 !important;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Hauptcontainer für die App -->
    <div id="app-container" class="container-card w-full bg-white rounded-xl p-6 md:p-10 transition-all duration-300">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">SEBU Lern-App Verkehrsrecht/Verkehrslehre</h1>
        <p class="text-gray-500 mb-6" id="app-subtitle">Wähle eine Übungskategorie, um zu starten.</p>

        <!-- Status-Anzeige (Nur aktuelle Punktzahl) -->
        <div class="flex justify-end items-center mb-6 text-sm">
            <span class="text-gray-600">Aktuelle Punktzahl: <span id="current-score" class="font-semibold text-cd-primary">0</span></span>
        </div>

        <!-- 1. Kategorieauswahl-Bereich -->
        <div id="category-selection" class="">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Wähle eine Kategorie:</h2>
            <div id="category-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Kategorien werden hier per JavaScript eingefügt -->
            </div>
        </div>

        <!-- 2. Quiz-Bereich -->
        <div id="quiz-area" class="hidden">
            <!-- Frage -->
            <div id="question-box" class="bg-gray-100 border-l-4 border-cd-primary p-6 mb-8 rounded-lg">
                <p id="question-text" class="text-xl font-medium text-gray-800">Frage wird geladen...</p>
                <div id="explanation-text" class="mt-4 hidden text-sm text-gray-600 border-t border-gray-300 pt-2"></div>
            </div>

            <!-- Antwort-Optionen / Text Input -->
            <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                <!-- Buttons oder Input-Feld werden hier per JavaScript eingefügt -->
            </div>

            <!-- Feedback und Weiter-Button -->
            <div id="feedback-area" class="min-h-[60px] flex items-center justify-between">
                <div id="feedback-message" class="text-lg font-semibold"></div>
                <!-- Der Check-Button für MC/TEXT wird dynamisch per JS hinzugefügt/angezeigt -->
                <button id="next-button" disabled
                    class="bg-cd-primary text-white px-6 py-3 rounded-lg font-semibold hover:bg-cd-hover transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                    Nächste Frage
                </button>
            </div>
            <button id="back-to-categories-quiz"
                    class="mt-4 text-sm text-gray-500 hover:text-cd-primary transition-colors">
                Zurück zur Kategorieauswahl
            </button>
        </div>

        <!-- 3. Endergebnis-Bereich -->
        <div id="result-area" class="hidden text-center p-10 bg-green-50 rounded-xl">
            <h2 class="text-2xl font-bold text-green-700 mb-4">Quiz beendet!</h2>
            <p class="text-xl text-gray-700 mb-6">Du hast <span id="final-score" class="font-extrabold text-green-900">0</span> von <span id="total-questions" class="font-extrabold text-green-900">0</span> Fragen korrekt beantwortet.</p>
            <button id="restart-button"
                class="bg-cd-primary text-white px-6 py-3 rounded-lg font-semibold hover:bg-cd-hover transition-colors">
                Neues Quiz starten
            </button>
        </div>
    </div>

    <!-- Entferne Firebase SDKs importieren Block, da die App jetzt rein lokal ist. -->
    <script>
        // --- Globale Variablen ---
        let allQuestions = []; // Alle Fragen aus der lokalen Quelle
        let currentQuizQuestions = []; // Fragen für das aktuelle Quiz
        let currentQuestionIndex = 0;
        let currentScore = 0;
        let isQuestionActive = true;
        let selectedMCIndices = []; // Speichert die ausgewählten Indizes für MC-Fragen
        
        // --- Initiale Quizfragen (Lokale Quelle) ---
        const getInitialQuestionsData = () => {
             // FRAGEN BASIEREND AUF DER VORLAGE DES NUTZERS 
             const cat1 = "§ 1 Abs. 2 StVO"; 
             const cat2 = "Höchstgeschwindigkeit"; 
             const cat3 = "TBNR Abstand"; 
             const cat4 = "TBNR/BKatV"; 
             
             // Standardisierter Fragesatz und Hinweis für TEXT-Fragen
             const prefix = "Bestimmen Sie die zulässige Höchstgeschwindigkeit für ";
             const suffix = ". Hinweis: Sofern keine zulässige Höchstgeschwindigkeit existiert, geben Sie bitte \"0\" ein.";

             // *** NEU: TBNR Präfix ***
             const tbnrPrefix = "Bestimme die TBNR für ";

            return [
                // === KATEGORIE 1: Übung zu § 1 Abs. 2 StVO (5 Fragen) ===
                // 1. MC: Tatbestandsmerkmale § 1 Abs. 2 StVO
                {
                    category: cat1,
                    type: 'MC',
                    text: "Welche Tatbestandsmerkmale gehören zu § 1 Abs. 2 StVO?",
                    options: [
                        "Fahrzeugführer",
                        "Verkehrsteilnehmer", 
                        "Fahrbahn",
                        "Fahrstreifen",
                        "Gefährdung", 
                        "Vermeidbarkeit", 
                        "Rücksichtnahme"
                    ],
                    correctIndices: [1, 4, 5], 
                    explanation: "Lies zum besseren Verständnis noch einmal § 1 Abs. 2 StVO."
                },
                // 2. MC: Voraussetzung der Vermeidbarkeit
                {
                    category: cat1, 
                    type: 'MC', 
                    text: "Auf welche der vier tatbestandlichen Varianten bezieht sich die Vermeidbarkeit?",
                    options: [
                        "Schädigung",
                        "Gefährdung",
                        "Behinderung", 
                        "Belästigung" 
                    ],
                    correctIndices: [2, 3], 
                    explanation: "Bei Schädigung und Gefährdung spielt die Vermeidbarkeit keine Rolle."
                },
                // 3. MC: "Anderer" im Sinne des § 1 Abs. 2 StVO
                {
                    category: cat1,
                    type: 'MC',
                    text: "Wer kann „Anderer“ im Sinne der Norm sein?",
                    options: [
                        "Verletzte Person", 
                        "Eigentümer einer Sache", 
                        "Tiere",
                        "Pkw",
                        "Schutzplanke"
                    ],
                    correctIndices: [0, 1], 
                    explanation: "Der Begriff „Anderer“ bezieht sich auf Personen oder geschützte Rechtsgüter (Sachen/Eigentum) und umfasst daher nicht Tiere oder tote Objekte wie Schutzplanken." 
                },
                // 4. SC: Personenschaden
                {
                    category: cat1, 
                    type: 'SC',
                    text: "Wer kann einen Personenschaden im Sinne der Norm erleiden?",
                    options: [
                        "Natürliche Person", 
                        "juristische Person",
                        "beide"
                    ],
                    correctIndex: 0,
                    explanation: "Juristische Personen sind „Rechtskonstrukte“ und können nicht unmittelbar verletzt werden"
                },
                // 5. SC: Sachschaden
                {
                    category: cat1, 
                    type: 'SC',
                    text: "Wer kann einen Sachschaden im Sinne der Norm erleiden",
                    options: [
                        "Natürliche Person",
                        "juristische Person",
                        "beide" 
                    ],
                    correctIndex: 2,
                    explanation: "Auch juristische Personen, bspw. als Eigentümer einer Sache, können einen Sachschaden erleiden"
                },

                // === KATEGORIE 2: Übung zu Höchstgeschwindigkeiten (10 Fragen - Typ: TEXT, EXAKT NACH VORGABE) ===
                { 
                    category: cat2, 
                    type: 'TEXT', 
                    text: `${prefix}Pkw igO${suffix}`, 
                    correctAnswer: "50", 
                    explanation: "Innerhalb geschlossener Ortschaften gilt für alle Kraftfahrzeuge in der Regel 50 km/h (§ 3 Abs. 3 StVO)." 
                },
                { 
                    category: cat2, 
                    type: 'TEXT', 
                    text: `${prefix}Lkw 12t agO${suffix}`, 
                    correctAnswer: "60", 
                    explanation: "Fahrzeuge über 7,5 t (hier 12 t) dürfen außerorts (auch auf der Autobahn) maximal 60 km/h fahren (§ 3 Abs. 3 StVO)."
                },
                { 
                    category: cat2, 
                    type: 'TEXT', 
                    text: `${prefix}KOM stehende Fahrgäste igO${suffix}`, 
                    correctAnswer: "60", 
                    explanation: "" 
                },
                { 
                    category: cat2, 
                    type: 'TEXT', 
                    text: `${prefix}Pkw auf BAB${suffix}`, 
                    correctAnswer: "0", 
                    explanation: "Hinweis: Die Autobahnrichtgeschwindigkeitsverordnung (130 km/h) ist lediglich Empfehlung" 
                },
                { 
                    category: cat2, 
                    type: 'TEXT', 
                    text: `${prefix}Motorrad agO${suffix}`, 
                    correctAnswer: "100", 
                    explanation: "Für Motorräder gilt außerorts die allgemeine Höchstgeschwindigkeit von 100 km/h (§ 3 Abs. 3 StVO)." 
                },
                { 
                    category: cat2, 
                    type: 'TEXT', 
                    text: `${prefix}Lkw 36 t bei Z 274-70 agO${suffix}`, 
                    correctAnswer: "60", 
                    explanation: "Beachte Z. 274-70 Nr. 3 StVO, wonach die Geschwindigkeit aus § 3 Abs. 3 Nr. 2 lit. b sublit. aa StVO bestehen bleibt." 
                },
                { 
                    category: cat2, 
                    type: 'TEXT', 
                    text: `${prefix}Wohnmobil 4,2 t igO Zweirichtungsverkehr mit jeweils zwei Fahrstreifen pro Richtung${suffix}`, 
                    correctAnswer: "80", 
                    explanation: "Beachte § 3 Abs. 3 Nr. 2 lit. c S. 2 StVO" 
                },
                { 
                    category: cat2, 
                    type: 'TEXT', 
                    text: `${prefix}Lkw 7,5 t mit Anhänger agO${suffix}`, 
                    correctAnswer: "80", 
                    explanation: "Für LKW mit Anhänger gilt außerhalb geschlossener Ortschaften maximal 80 km/h."
                },
                { 
                    category: cat2, 
                    type: 'TEXT', 
                    text: `${prefix}Motorrad mit Beiwagen igO${suffix}`, 
                    correctAnswer: "50", 
                    explanation: "Innerorts gilt für alle Kraftfahrzeuge (dazu zählt auch ein Motorrad mit Beiwagen) die allgemeine Höchstgeschwindigkeit von 50 km/h, sofern nicht anders beschildert."
                },
                { 
                    category: cat2, 
                    type: 'TEXT', 
                    text: `${prefix}Pkw/Anhänger auf BAB${suffix}`, 
                    correctAnswer: "100", 
                    explanation: "Beachte 9. StVOAusnV 9" 
                },

                // === KATEGORIE 3: Übungen zu TBNR Abstand (2 Fragen) ===
                {
                    category: cat3, 
                    type: 'TEXT',
                    text: `${tbnrPrefix}Pkw, agO, Zweirichtungsverkehr, jeweils zwei Fahrstreifen, V=100 km/h, s=40 m`, 
                    correctAnswer: "104100", 
                    explanation: "" // Keine Erklärung vom Nutzer bereitgestellt
                },
                // NEUE FRAGE HINZUGEFÜGT
                {
                    category: cat3, 
                    type: 'TEXT',
                    text: `${tbnrPrefix}Lkw, 12 t, agO, Zweirichtungsverkehr, ein Fahrstreifen/Richtung, V=80 km/h, s=45 m`, 
                    correctAnswer: "104124", 
                    explanation: "" // Keine Erklärung vom Nutzer bereitgestellt
                },

                // === KATEGORIE 4: NEU: TBNR/BKatV (7 Fragen) ===
                // 1. Frage: Bedeutung 1. Ziffer
                 {
                    category: cat4,
                    type: 'SC',
                    text: "Wofür steht die 1. Ziffer der TBNR?",
                    options: [
                        "Paragraf aus der jeweiligen Verordnung", 
                        "Verordnung", // Korrekt: Verordnung
                        "Geldbetrag",
                        "Schlüsselnummer des Verstoßes"
                    ],
                    correctIndex: 1, 
                    explanation: "" 
                },
                // 2. Frage: Bedeutung 2. und 3. Ziffer
                {
                    category: cat4,
                    type: 'SC',
                    text: "Wofür stehen die 2. und 3. Ziffer der TBNR?",
                    options: [
                        "Paragraf aus der jeweiligen Verordnung", // Korrekt: Paragraf
                        "Verordnung",
                        "Geldbetrag",
                        "Schlüsselnummer des Verstoßes"
                    ],
                    correctIndex: 0, 
                    explanation: "" 
                },
                // 3. Frage: Bedeutung 4.-6. Ziffer
                {
                    category: cat4,
                    type: 'SC',
                    text: "Wofür stehen die 4. bis 6. Ziffer der TBNR?",
                    options: [
                        "Paragraf aus der jeweiligen Verordnung", 
                        "Verordnung",
                        "Geldbetrag",
                        "Schlüsselnummer des Verstoßes" // Korrekt: Schlüsselnummer
                    ],
                    correctIndex: 3, 
                    explanation: "" 
                },
                // 4. FRAGE: Rechtsgrundlage
                {
                    category: cat4,
                    type: 'SC',
                    text: "Aus welcher Rechtsgrundlage ergibt sich die Unterscheidung zwischen Verwarnungsgeld und Bußgeld?",
                    options: [
                        "§ 49 StVO",
                        "§ 1 Abs. 1 BKatV", // Korrekt
                        "§ 24 Abs. 1 StVG",
                        "§ 19 OWiG"
                    ],
                    correctIndex: 1, 
                    explanation: "" // Keine Erklärung vom Nutzer bereitgestellt
                },
                // 5. FRAGE: Aussagen
                {
                    category: cat4,
                    type: 'MC',
                    text: "Welche Aussagen sind richtig?",
                    options: [
                        "Verwarnungsgelder müssen in 5-Euro-Schritten erhoben werden.", // 0 (richtig)
                        "Bußgelder dürfen vor Ort erhoben werden.", // 1 (falsch)
                        "Bei Verwarnungsgeldern und Bußgeldern fallen Verwaltungsgebühren an.", // 2 (falsch)
                        "Verwarnungsgelder dürfen nach eigenem Ermessen erhöht werden", // 3 (richtig)
                        "Bußgelder dürfen bei Radfahrern auf 15 Euro reduziert werden.", // 4 (falsch)
                        "Bußgelder müssen bei Vorsatz verdoppelt werden", // 5 (richtig)
                        "Bei Einsicht des Betroffenen darf grundsätzlich mündlich verwarnt werden", // 6 (falsch)
                        "Fußgänger bezahlten grundsätzlich nur 5 Euro" // 7 (falsch)
                    ],
                    correctIndices: [0, 3, 5], 
                    explanation: "" // Keine Erklärung vom Nutzer bereitgestellt
                },
                // 6. FRAGE: Tateinheit
                {
                    category: cat4,
                    type: 'MC',
                    text: "Welche Rechtsnormen sind bei vorliegender Tateinheit einschlägig?",
                    options: [
                        "§ 19 OWiG", // 0 (richtig)
                        "§ 20 OWiG", // 1 (falsch)
                        "§ 2 Abs. 6 BKatV", // 2 (richtig)
                        "§ 2 Abs. 7 BKatV", // 3 (falsch)
                        "§ 3 Abs. 5 BKatV" // 4 (richtig)
                    ],
                    correctIndices: [0, 2, 4], 
                    explanation: "" // Keine Erklärung vom Nutzer bereitgestellt
                },
                // 7. FRAGE: NEU HINZUGEFÜGT (MC) - Tatmehrheit
                {
                    category: cat4,
                    type: 'MC',
                    text: "Welche Rechtsnormen sind bei vorliegender Tatmehrheit einschlägig?",
                    options: [
                        "§ 19 OWiG", // 0 (falsch)
                        "§ 20 OWiG", // 1 (richtig)
                        "§ 2 Abs. 6 BKatV", // 2 (falsch)
                        "§ 2 Abs. 7 BKatV", // 3 (richtig)
                        "§ 3 Abs. 5 BKatV" // 4 (falsch)
                    ],
                    correctIndices: [1, 3], 
                    explanation: "" // Keine Erklärung vom Nutzer bereitgestellt
                },
            ];
        };

        // DOM-Elemente
        const elements = {
            categorySelection: document.getElementById('category-selection'),
            categoryContainer: document.getElementById('category-container'),
            quizArea: document.getElementById('quiz-area'),
            questionText: document.getElementById('question-text'),
            explanationText: document.getElementById('explanation-text'),
            optionsContainer: document.getElementById('options-container'),
            feedbackMessage: document.getElementById('feedback-message'),
            nextButton: document.getElementById('next-button'),
            currentScore: document.getElementById('current-score'),
            resultArea: document.getElementById('result-area'),
            finalScore: document.getElementById('final-score'),
            totalQuestions: document.getElementById('total-questions'),
            restartButton: document.getElementById('restart-button'),
            appSubtitle: document.getElementById('app-subtitle'),
            backToCategoriesQuiz: document.getElementById('back-to-categories-quiz'),
            feedbackArea: document.getElementById('feedback-area') 
        };
        
        // --- View Manager ---
        const setView = (viewName) => {
            // Standardmäßig alle Bereiche verstecken
            elements.categorySelection.classList.add('hidden');
            elements.quizArea.classList.add('hidden');
            elements.resultArea.classList.add('hidden');
            elements.appSubtitle.textContent = "Wähle eine Übungskategorie, um zu starten.";
            
            // Verstecke den MC/TEXT-Check-Button beim Ansichtenwechsel
            document.getElementById('check-answer-button')?.classList.add('hidden');
            elements.nextButton.classList.remove('hidden'); // Stelle sicher, dass "Nächste Frage" sichtbar ist

            switch (viewName) {
                case 'categories':
                    elements.categorySelection.classList.remove('hidden');
                    elements.appSubtitle.textContent = "Wähle eine Übungskategorie, um zu starten.";
                    break;
                case 'quiz':
                    elements.quizArea.classList.remove('hidden');
                    elements.appSubtitle.textContent = "Teste dein Wissen!";
                    break;
                case 'results':
                    elements.resultArea.classList.remove('hidden');
                    elements.appSubtitle.textContent = "Das Quiz ist beendet.";
                    break;
            }
        };

        // --- Fragen Laden (Vereinfacht) ---
        const loadQuestions = () => {
            allQuestions = getInitialQuestionsData();
            showCategories();
        };

        // --- Quiz- und Kategorielogik (Funktionalität unverändert) ---

        const showCategories = () => {
            setView('categories');
            elements.categoryContainer.innerHTML = '';
            
            // Gruppiere die Fragen nach Kategorie und zähle sie
            const questionCounts = allQuestions.reduce((acc, q) => {
                acc[q.category] = (acc[q.category] || 0) + 1;
                return acc;
            }, {});

            // Iteriere über die gefundenen Kategorien, um Karten zu erstellen
            Object.keys(questionCounts).forEach(category => {
                const count = questionCounts[category];
                
                if (count > 0) { 
                    const card = document.createElement('div');
                    card.className = 'category-card cursor-pointer p-6 bg-white border-2 border-gray-200 rounded-lg shadow-md';
                    card.innerHTML = `
                        <h3 class="text-lg font-bold text-gray-800">${category}</h3>
                        <p class="text-sm text-gray-500 mt-1">${count} Frage${count === 1 ? '' : 'n'} verfügbar</p>
                        <button class="mt-4 w-full bg-cd-primary text-white py-2 rounded-lg text-sm font-semibold hover:bg-cd-hover transition-colors">
                            Starten
                        </button>
                    `;
                    card.onclick = () => startQuiz(category);
                    elements.categoryContainer.appendChild(card);
                }
            });
            
            if (elements.categoryContainer.children.length === 0) {
                 elements.categoryContainer.innerHTML = `<p class="text-gray-500">Es sind aktuell keine Fragen verfügbar.</p>`;
            }
        };

        const shuffleArray = (array) => {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        };

        const startQuiz = (categoryName) => {
            currentQuizQuestions = allQuestions.filter(q => q.category === categoryName);

            if (currentQuizQuestions.length === 0) {
                console.error(`Keine Fragen für die Kategorie "${categoryName}" gefunden.`);
                return;
            }

            currentScore = 0;
            currentQuestionIndex = 0;
            elements.currentScore.textContent = 0;
            
            currentQuizQuestions = shuffleArray(currentQuizQuestions); 
            
            setView('quiz');
            elements.nextButton.disabled = true;
            elements.feedbackMessage.textContent = '';
            
            showQuestion();
        };
        
        // --- TEXT Input Validierung (Nur erlaubte Zahlen) ---
        const validateTextInput = (value) => {
            // Die erlaubten Antworten im Quiz
            const inputField = document.getElementById('text-answer-input');
            const checkButton = document.getElementById('check-answer-button');
            const feedbackDiv = document.getElementById('text-input-feedback');
            const trimmedValue = String(value).trim();
        
            if (trimmedValue === "") {
                if (checkButton) checkButton.disabled = true;
                if (feedbackDiv) feedbackDiv.classList.add('hidden');
                if (inputField) inputField.classList.remove('border-red-500'); 
                return false;
            }
            
            // Dynamische Logik für TEXT-Fragen
            const question = currentQuizQuestions[currentQuestionIndex];
            let isValid = false;
            let feedbackText = ""; 

            if (question.category === "TBNR Abstand") { // TBNR
                isValid = /^\d{6}$/.test(trimmedValue); // Muss 6 Ziffern sein
                feedbackText = "TBNR muss eine 6-stellige Zahl sein.";
            } else if (question.category === "Höchstgeschwindigkeit") { // Geschwindigkeit
                const validValues = ["0", "50", "60", "80", "100", "120"];
                isValid = validValues.includes(trimmedValue);
                feedbackText = "Nur die Zahlen 0, 50, 60, 80, 100 oder 120 sind erlaubt.";
            } else {
                // Fallback, falls andere TEXT-Fragen existieren
                isValid = true; 
            }
            
            if (!isValid) {
                if (checkButton) checkButton.disabled = true;
                if (inputField) inputField.classList.add('border-red-500');
                if (feedbackDiv) {
                    feedbackDiv.textContent = feedbackText; // Dynamisches Feedback
                    feedbackDiv.classList.remove('hidden');
                }
                return false;
            }
            
            if (checkButton) checkButton.disabled = false;
            if (inputField) inputField.classList.remove('border-red-500');
            if (feedbackDiv) feedbackDiv.classList.add('hidden');
            return true;
        };


        const showQuestion = () => {
            if (currentQuestionIndex >= currentQuizQuestions.length) {
                endQuiz();
                return;
            }

            const question = currentQuizQuestions[currentQuestionIndex];
            const isMC = question.type === 'MC'; 
            const isTEXT = question.type === 'TEXT'; 
            
            elements.questionText.textContent = `Frage ${currentQuestionIndex + 1}/${currentQuizQuestions.length}: ${question.text}`;
            elements.optionsContainer.innerHTML = '';
            elements.feedbackMessage.textContent = '';
            elements.nextButton.disabled = true;
            isQuestionActive = true;
            selectedMCIndices = []; 
            
            elements.explanationText.classList.add('hidden');
            elements.explanationText.innerHTML = '';

            const checkButtonId = 'check-answer-button';
            let checkButton = document.getElementById(checkButtonId);
            
            // Erzeuge den Check-Button, falls er noch nicht existiert
            if (!checkButton) {
                checkButton = document.createElement('button');
                checkButton.id = checkButtonId;
                checkButton.textContent = 'Antwort prüfen';
                checkButton.className = 'bg-cd-primary text-white px-6 py-3 rounded-lg font-semibold hover:bg-cd-hover transition-colors disabled:opacity-50 disabled:cursor-not-allowed';
                elements.feedbackArea.appendChild(checkButton); 
            }
            
            // Steuerung der Button-Sichtbarkeit
            if (isMC || isTEXT) {
                checkButton.classList.remove('hidden');
                elements.nextButton.classList.add('hidden'); 
                checkButton.disabled = true; 
                checkButton.onclick = isMC ? checkMCAnswer : checkTextAnswer; 
                elements.optionsContainer.className = isMC ? 'grid grid-cols-1 md:grid-cols-2 gap-4 mb-8' : 'flex justify-center mb-8';

            } else { // SC-Fragen
                checkButton.classList.add('hidden');
                elements.nextButton.classList.remove('hidden'); 
                elements.optionsContainer.className = 'grid grid-cols-1 md:grid-cols-2 gap-4 mb-8';
            }


            if (isTEXT) {
                // Dynamischer Placeholder und Typ für TEXT-Fragen
                let placeholder = "Zahl eingeben";
                let feedbackText = "Ungültige Eingabe.";
                let inputType = "number"; // Standard

                if (question.category === "TBNR Abstand") { // TBNR
                    placeholder = "TBNR (6 Ziffern)";
                    feedbackText = "TBNR muss eine 6-stellige Zahl sein.";
                    inputType = "text"; 
                } else if (question.category === "Höchstgeschwindigkeit") { // Geschwindigkeit
                    placeholder = "Geschw. in km/h";
                    feedbackText = "Nur die Zahlen 0, 50, 60, 80, 100 oder 120 sind erlaubt.";
                    inputType = "number";
                }

                // Anzeigevorlage für Freitext-Eingabe
                elements.optionsContainer.innerHTML = `
                    <div class="w-full max-w-sm">
                        <input type="${inputType}" id="text-answer-input" placeholder="${placeholder}"
                               class="w-full p-4 border-2 border-gray-300 rounded-lg text-lg text-center focus:border-cd-primary focus:ring-cd-primary"
                               ${inputType === 'number' ? 'min="0"' : ''} oninput="validateTextInput(this.value)">
                        <div id="text-input-feedback" class="mt-2 text-sm text-red-500 hidden">${feedbackText}</div>
                    </div>
                `;
            } else {
                // Generierung der Buttons für MC/SC
                question.options.forEach((option, index) => {
                    const button = document.createElement('button');
                    button.textContent = option;
                    
                    let buttonClass = 'option-button w-full text-left p-4 rounded-lg font-medium transition-colors duration-200 border ';

                    if (isMC) {
                        buttonClass += 'bg-gray-50 border-gray-200 hover:bg-gray-100';
                        button.onclick = () => toggleSelection(index, button); 
                    } else { // SC
                        buttonClass += 'bg-gray-50 border-gray-200 hover:bg-gray-100'; 
                        button.onclick = () => handleSCAnswer(index, question.correctIndex, button); 
                    }
                    
                    button.className = buttonClass;
                    elements.optionsContainer.appendChild(button);
                });
            }
        };
        
        const toggleSelection = (index, button) => {
            if (!isQuestionActive) return;
            
            if (button.classList.contains('selected-mc')) {
                button.classList.remove('selected-mc');
                selectedMCIndices = selectedMCIndices.filter(i => i !== index);
            } else {
                button.classList.add('selected-mc');
                selectedMCIndices.push(index);
            }
            
            const checkButton = document.getElementById('check-answer-button');
            if (checkButton) {
                checkButton.disabled = selectedMCIndices.length === 0;
            }
        };

        const handleSCAnswer = (selectedIndex, correctIndex, selectedButton) => {
            if (!isQuestionActive) return;

            isQuestionActive = false;

            Array.from(elements.optionsContainer.children).forEach(btn => {
                btn.disabled = true;
                btn.classList.add('cursor-default');
            });
            
            const isCorrect = selectedIndex === correctIndex;
            provideFeedback(isCorrect);
            
            selectedButton.classList.add(isCorrect ? 'correct' : 'incorrect');
            if (!isCorrect) {
                const correctButton = elements.optionsContainer.children[correctIndex];
                if (correctButton) {
                    correctButton.classList.add('correct');
                }
            }
            
            elements.nextButton.disabled = false;
        };
        
        const checkMCAnswer = () => {
            if (!isQuestionActive) return;
            
            isQuestionActive = false;
            
            const question = currentQuizQuestions[currentQuestionIndex];
            
            const correctIndices = (question.correctIndices || []).slice().sort((a, b) => a - b);
            const sortedSelectedIndices = selectedMCIndices.slice().sort((a, b) => a - b);
            
            const isCorrect = correctIndices.length === sortedSelectedIndices.length &&
                              correctIndices.every((val, index) => val === sortedSelectedIndices[index]);

            provideFeedback(isCorrect);
            
            Array.from(elements.optionsContainer.children).forEach((btn, index) => {
                const isCorrectOption = correctIndices.includes(index);
                const isSelected = sortedSelectedIndices.includes(index);
                
                btn.disabled = true;
                btn.classList.add('cursor-default');
                btn.classList.remove('selected-mc'); 

                if (isCorrectOption) {
                    btn.classList.add('correct');
                } else if (!isCorrectOption && isSelected) {
                    btn.classList.add('incorrect');
                }
            });
            
            document.getElementById('check-answer-button')?.classList.add('hidden');
            elements.nextButton.classList.remove('hidden');
            elements.nextButton.disabled = false;
        };
        
        // --- Neue Funktion für Freitextantworten (TEXT) ---
        const checkTextAnswer = () => {
            if (!isQuestionActive) return;
            
            const inputField = document.getElementById('text-answer-input');
            const checkButton = document.getElementById('check-answer-button');
            const question = currentQuizQuestions[currentQuestionIndex];
            
            const inputValue = String(inputField.value).trim();

            if (!validateTextInput(inputValue)) {
                elements.feedbackMessage.textContent = 'Fehler: Ungültige Eingabe.';
                elements.feedbackMessage.className = 'text-lg font-semibold text-red-600';
                return;
            }
            
            isQuestionActive = false;
            inputField.disabled = true;

            const isCorrect = inputValue === question.correctAnswer;
            
            // Visuelles Feedback auf dem Input-Feld
            inputField.classList.add(isCorrect ? 'correct' : 'incorrect');
            inputField.classList.remove('border-gray-300', 'border-red-500', 'focus:border-cd-primary', 'focus:ring-cd-primary');
            
            // Allgemeines Feedback
            provideFeedback(isCorrect, isCorrect ? '' : `Korrekte Antwort: ${question.correctAnswer} km/h`);

            checkButton.classList.add('hidden');
            elements.nextButton.classList.remove('hidden');
            elements.nextButton.disabled = false;
        };


        const provideFeedback = (isCorrect, correctText = '') => {
            const currentQuestion = currentQuizQuestions[currentQuestionIndex];
            
            if (isCorrect) {
                currentScore++;
                elements.currentScore.textContent = currentScore;
                elements.feedbackMessage.textContent = 'Richtig! Gut gemacht.';
                elements.feedbackMessage.className = 'text-lg font-semibold text-green-600';
            } else {
                elements.feedbackMessage.textContent = 'Falsch. Die korrekte(n) Antwort(en) ist/sind markiert.';
                elements.feedbackMessage.className = 'text-lg font-semibold text-red-600';
                
                // Erklärung für Falsche Antworten
                if (currentQuestion.type === 'TEXT') {
                     // Dynamisches Feedback für TEXT-Fragen
                     let explanationHtml = `**Falsch.** Die korrekte Antwort lautet: ${currentQuestion.correctAnswer}`;
                     if (currentQuestion.category === "Höchstgeschwindigkeit") { 
                         explanationHtml = `**Falsch.** Die zulässige Höchstgeschwindigkeit beträgt: ${currentQuestion.correctAnswer} km/h.`;
                     } else if (currentQuestion.category === "TBNR Abstand") { 
                         explanationHtml = `**Falsch.** Die korrekte TBNR lautet: ${currentQuestion.correctAnswer}.`;
                     }
                     
                     if (currentQuestion.explanation) {
                         // Fügt den wortwörtlichen Hinweis des Nutzers hinzu
                         explanationHtml += `<br>**Hinweis:** ${currentQuestion.explanation}`;
                     }
                     elements.explanationText.innerHTML = explanationHtml;
                     elements.explanationText.classList.remove('hidden');
                } else if (currentQuestion.explanation) {
                    elements.explanationText.innerHTML = `**Erklärung:** ${currentQuestion.explanation}`;
                    elements.explanationText.classList.remove('hidden');
                }
            }
        };

        const nextQuestion = () => {
            currentQuestionIndex++;
            showQuestion();
        };

        const endQuiz = () => {
            setView('results');
            
            elements.finalScore.textContent = currentScore;
            elements.totalQuestions.textContent = currentQuizQuestions.length;
            
            // Highscore-Speicherlogik entfernt
        };
        
        // --- Event Listener ---
        elements.nextButton.addEventListener('click', nextQuestion);
        
        elements.restartButton.addEventListener('click', showCategories); 
        
        elements.backToCategoriesQuiz.addEventListener('click', showCategories);


        // --- Start der App ---
        // Die App startet direkt mit dem Laden der lokalen Fragen
        loadQuestions();

    </script>
</body>
</html>
